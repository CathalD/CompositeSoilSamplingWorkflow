// =================================================================================
// === COMPOSITE SAMPLING WITH HR CORE PAIRING TOOL - FIXED VERSION ================
// === Robust implementation avoiding projection issues ============================
// =================================================================================
//
// PURPOSE: Generate hierarchical sampling design with:
//   - High Resolution (HR) soil cores for detailed analysis
//   - Composite samples (multiple subsamples) for broader coverage
//   - Strategic pairing between composites and HR cores
//
// FIXED: Resolved geometry projection issues by using WGS84-compatible operations
//
// =================================================================================
// === 1. CONFIGURATION ============================================================
// =================================================================================

var CONFIG = {
  // Sampling Design Parameters
  DEFAULT_HR_CORES: 10,
  DEFAULT_COMPOSITES_PER_STRATUM: 20,
  DEFAULT_COMPOSITE_AREA: 25, // m¬≤
  DEFAULT_SUBSAMPLES: 5,
  DEFAULT_PAIRING_FRACTION: 0.4,
  DEFAULT_MAX_PAIRING_DISTANCE: 5000, // meters
  
  // Analysis Parameters
  CARBON_SCALE: 250, // meters
  MAX_PIXELS: 1e10,
  MAX_ERROR: 1, // meters for geometry operations
  
  // Seed for reproducibility
  RANDOM_SEED: 42
};

var STYLES = {
  TITLE: {fontSize: '28px', fontWeight: 'bold', color: '#005931'},
  SUBTITLE: {fontSize: '18px', fontWeight: '500', color: '#333333'},
  PARAGRAPH: {fontSize: '14px', color: '#555555'},
  HEADER: {fontSize: '16px', fontWeight: 'bold', margin: '16px 0 4px 8px'},
  SUBHEADER: {fontSize: '14px', fontWeight: 'bold', margin: '10px 0 0 0'},
  PANEL: {width: '420px', border: '1px solid #cccccc'},
  HR: ui.Panel(null, ui.Panel.Layout.flow('horizontal'), {
    border: '1px solid #E0E0E0',
    margin: '20px 0px'
  }),
  INSTRUCTION: {fontSize: '12px', color: '#999999', margin: '4px 8px'},
  SUCCESS: {fontSize: '13px', color: '#388E3C', fontWeight: 'bold', margin: '8px'},
  ERROR: {fontSize: '13px', color: '#D32F2F', fontWeight: 'bold', margin: '8px'},
  WARNING: {fontSize: '13px', color: '#F57C00', fontWeight: 'bold', margin: '8px'}
};

// =================================================================================
// === 2. DATA SOURCES =============================================================
// =================================================================================

var forestCarbon = ee.ImageCollection("projects/sat-io/open-datasets/carbon_stocks_ca/fc").first();
var soilCarbon = ee.ImageCollection("projects/sat-io/open-datasets/carbon_stocks_ca/sc").first();

var palettes = require('users/gena/packages:palettes');
var fcVis = {palette: palettes.colorbrewer.Greens[7], min: 0, max: 20};
var scVis = {palette: palettes.colorbrewer.Purples[7], min: 5, max: 30};

// =================================================================================
// === 3. STATE MANAGEMENT =========================================================
// =================================================================================

var AppState = {
  currentAoi: null,
  hrCores: null,
  composites: null,
  subsamples: null,
  pairedComposites: null,
  carbonStats: null,
  
  reset: function() {
    this.currentAoi = null;
    this.hrCores = null;
    this.composites = null;
    this.subsamples = null;
    this.pairedComposites = null;
    this.carbonStats = null;
  }
};

// =================================================================================
// === 4. FIXED UTILITY FUNCTIONS ==================================================
// =================================================================================

var Utils = {
  /**
   * Validates numeric input within range
   */
  validateNumber: function(value, min, max, name) {
    var num = parseFloat(value);
    if (isNaN(num) || num < min || num > max) {
      return {
        valid: false,
        message: name + ' must be between ' + min + ' and ' + max
      };
    }
    return {valid: true, value: num};
  },
  
  /**
   * Format numbers with thousand separators
   */
 formatNumber: function(num, decimals) {
  decimals = decimals !== undefined ? decimals : 0;
  if (num === null || num === undefined) return '0';
  return num.toLocaleString('en-US', {
    minimumFractionDigits: decimals,
    maximumFractionDigits: decimals
  });
},
  
  /**
   * FIXED: Creates systematic grid using WGS84-compatible approach
   */
  createSystematicGrid: function(polygon, nPoints, seed) {
    // Use stratified random sampling for grid-like distribution
    // This avoids projection issues while maintaining systematic coverage
    
    // Create a coarse grid using sample
    var gridImage = ee.Image.random(seed).multiply(1000000).int();
    
    var samples = gridImage.stratifiedSample({
      numPoints: nPoints,
      region: polygon,
      scale: CONFIG.CARBON_SCALE,
      geometries: true
    });
    
    // Convert to feature collection with proper geometry
    var points = samples.map(function(f) {
      return ee.Feature(f.geometry());
    });
    
    return points.randomColumn('rand', seed);
  },
  
  /**
   * FIXED: Creates square polygon using buffer approach
   */
  createSquareBuffer: function(point, area_m2) {
    // Calculate radius for equivalent area
    // For a square inscribed in a circle: area = 2*r¬≤
    var radius = Math.sqrt(area_m2 / 2);
    
    // Create buffer (circular approximation)
    var buffer = point.geometry().buffer(radius, CONFIG.MAX_ERROR);
    
    // Get bounds of buffer to create rectangle
    var bounds = buffer.bounds(CONFIG.MAX_ERROR);
    
    return ee.Feature(bounds).set({
      'shape': 'square',
      'area_m2': area_m2,
      'method': 'bounds'
    });
  },
  
  /**
   * FIXED: Alternative square creation using rectangle
   */
  createSquareSimple: function(point, area_m2) {
    var side = Math.sqrt(area_m2);
    var halfSide = side / 2;
    
    // Get point coordinates
    var coords = point.geometry().coordinates();
    
    // Approximate degree conversion (latitude-dependent)
    // At equator: 1 degree ‚âà 111,320 meters
    var lat = coords.get(1);
    var cosLat = ee.Number(lat).multiply(Math.PI/180).cos();
    var metersPerDegreeLon = ee.Number(111320).multiply(cosLat);
    var metersPerDegreeLat = ee.Number(111320);
    
    var degreeOffsetLon = ee.Number(halfSide).divide(metersPerDegreeLon);
    var degreeOffsetLat = ee.Number(halfSide).divide(metersPerDegreeLat);
    
    var west = ee.Number(coords.get(0)).subtract(degreeOffsetLon);
    var east = ee.Number(coords.get(0)).add(degreeOffsetLon);
    var south = ee.Number(coords.get(1)).subtract(degreeOffsetLat);
    var north = ee.Number(coords.get(1)).add(degreeOffsetLat);
    
    // Create rectangle
    var rect = ee.Geometry.Rectangle([west, south, east, north]);
    
    return ee.Feature(rect).set({
      'shape': 'square',
      'area_m2': area_m2,
      'method': 'rectangle'
    });
  },
  
  /**
   * Creates circular composite area
   */
  createCircle: function(point, area_m2) {
    var radius = Math.sqrt(area_m2 / Math.PI);
    var buffer = point.geometry().buffer(radius, CONFIG.MAX_ERROR);
    return ee.Feature(buffer).set({
      'shape': 'circle',
      'area_m2': area_m2
    });
  },
  
  /**
   * Generates random points within a polygon
   */
  randomPointsInPolygon: function(polygon, count, seed) {
    return ee.FeatureCollection.randomPoints({
      region: polygon.geometry(),
      points: count,
      seed: seed
    });
  },
  
  /**
   * Calculate carbon statistics for a region
   */
  calculateCarbonStats: function(region) {
    var stats = soilCarbon.reduceRegion({
      reducer: ee.Reducer.mean()
        .combine(ee.Reducer.stdDev(), '', true)
        .combine(ee.Reducer.minMax(), '', true),
      geometry: region,
      scale: CONFIG.CARBON_SCALE,
      maxPixels: CONFIG.MAX_PIXELS,
      tileScale: 4  // Added for better memory management
    });
    
    return stats;
  }
};

// =================================================================================
// === 5. USER INTERFACE SETUP =====================================================
// =================================================================================

ui.root.clear();
var map = ui.Map();
var panel = ui.Panel({style: STYLES.PANEL});
var splitPanel = ui.SplitPanel(panel, map, 'horizontal', false);
ui.root.add(splitPanel);
map.setCenter(-95, 55, 4);

// --- Header ---
panel.add(ui.Label('Nature Meets Carbon - Sampling Toolkit', STYLES.TITLE));
panel.add(ui.Label('Composite Sampling with HR Core Pairing (Fixed)', STYLES.SUBTITLE));
panel.add(ui.Label(
  'Generate hierarchical sampling design with high-resolution soil cores paired with composite samples for efficient carbon assessment.',
  STYLES.PARAGRAPH
));
panel.add(STYLES.HR);

// --- Step 1: Define AOI ---
panel.add(ui.Label('Step 1: Define Sampling Area', STYLES.HEADER));

var assetIdBox = ui.Textbox({
  placeholder: 'e.g., users/your_name/your_asset',
  style: {stretch: 'horizontal', margin: '0 8px'}
});

var assetPanel = ui.Panel(
  [ui.Label('Enter GEE Asset Path:', STYLES.INSTRUCTION), assetIdBox],
  null,
  {shown: false}
);

var aoiSelection = ui.Select({
  items: ['Draw a polygon', 'Use a GEE Asset'],
  value: 'Draw a polygon',
  style: {stretch: 'horizontal', margin: '0 8px'},
  onChange: function(value) {
    assetPanel.style().set('shown', value === 'Use a GEE Asset');
    map.drawingTools().setShown(value === 'Draw a polygon');
  }
});

panel.add(aoiSelection);
panel.add(assetPanel);
panel.add(ui.Label('‚ñ∫ Draw your area of interest or provide asset path', STYLES.INSTRUCTION));

// --- Step 2: Configure Sampling Design ---
panel.add(ui.Label('Step 2: Configure Sampling Design', STYLES.HEADER));

// Sampling strategy selection
var strategySelect = ui.Select({
  items: ['Systematic Grid', 'Random', 'Stratified Random'],
  value: 'Systematic Grid',
  style: {stretch: 'horizontal', margin: '0 8px'}
});

panel.add(ui.Label('Sampling Strategy:', {margin: '8px 8px 4px 8px', fontWeight: 'bold'}));
panel.add(strategySelect);

// Composite shape selection
var shapeSelect = ui.Select({
  items: ['Square', 'Circle'],
  value: 'Square',
  style: {stretch: 'horizontal', margin: '0 8px'}
});

panel.add(ui.Label('Composite Shape:', {margin: '8px 8px 4px 8px', fontWeight: 'bold'}));
panel.add(shapeSelect);

// Numeric parameters
var hrCoresBox = ui.Textbox({
  placeholder: 'Number of HR cores',
  value: CONFIG.DEFAULT_HR_CORES.toString(),
  style: {width: '80px', margin: '0 8px'}
});

var compositesBox = ui.Textbox({
  placeholder: 'Per stratum',
  value: CONFIG.DEFAULT_COMPOSITES_PER_STRATUM.toString(),
  style: {width: '80px', margin: '0 8px'}
});

var compositeAreaBox = ui.Textbox({
  placeholder: 'Area in m¬≤',
  value: CONFIG.DEFAULT_COMPOSITE_AREA.toString(),
  style: {width: '80px', margin: '0 8px'}
});

var subsamplesBox = ui.Textbox({
  placeholder: 'Count',
  value: CONFIG.DEFAULT_SUBSAMPLES.toString(),
  style: {width: '80px', margin: '0 8px'}
});

var pairingFractionBox = ui.Textbox({
  placeholder: '0-1',
  value: CONFIG.DEFAULT_PAIRING_FRACTION.toString(),
  style: {width: '80px', margin: '0 8px'}
});

panel.add(ui.Label('HR Soil Cores (high detail):', {margin: '8px 8px 4px 8px', fontWeight: 'bold'}));
panel.add(ui.Panel([ui.Label('Number of cores:', {width: '150px'}), hrCoresBox], 
  ui.Panel.Layout.flow('horizontal')));

panel.add(ui.Label('Composite Samples:', {margin: '8px 8px 4px 8px', fontWeight: 'bold'}));
panel.add(ui.Panel([ui.Label('Per stratum:', {width: '150px'}), compositesBox], 
  ui.Panel.Layout.flow('horizontal')));
panel.add(ui.Panel([ui.Label('Area (m¬≤):', {width: '150px'}), compositeAreaBox], 
  ui.Panel.Layout.flow('horizontal')));
panel.add(ui.Panel([ui.Label('Subsamples per composite:', {width: '150px'}), subsamplesBox], 
  ui.Panel.Layout.flow('horizontal')));

panel.add(ui.Label('Pairing Strategy:', {margin: '8px 8px 4px 8px', fontWeight: 'bold'}));
panel.add(ui.Panel([ui.Label('Fraction to pair (0-1):', {width: '150px'}), pairingFractionBox], 
  ui.Panel.Layout.flow('horizontal')));

// --- Step 3: Generate Sampling Design ---
panel.add(ui.Label('Step 3: Generate Sampling Design', STYLES.HEADER));

var generateButton = ui.Button({
  label: 'Generate Sampling Locations',
  style: {stretch: 'horizontal', margin: '8px'},
  onClick: generateSamplingDesign
});
panel.add(generateButton);

var resultsPanel = ui.Panel({style: {margin: '0 8px'}});
panel.add(resultsPanel);

// --- Step 4: Export Results ---
panel.add(ui.Label('Step 4: Export Sampling Plan', STYLES.HEADER));

var exportFormatSelect = ui.Select({
  items: ['CSV', 'GeoJSON', 'KML', 'SHP'],
  value: 'CSV',
  style: {stretch: 'horizontal', margin: '0 8px'}
});
panel.add(ui.Label('Export Format:', {margin: '8px 8px 4px 8px', fontWeight: 'bold'}));
panel.add(exportFormatSelect);

var exportCompositesButton = ui.Button({
  label: '‚¨áÔ∏è Export Composite Polygons',
  style: {stretch: 'horizontal', margin: '4px 8px'},
  disabled: true
});

var exportSubsamplesButton = ui.Button({
  label: '‚¨áÔ∏è Export Subsample Points',
  style: {stretch: 'horizontal', margin: '4px 8px'},
  disabled: true
});

var exportHRCoresButton = ui.Button({
  label: '‚¨áÔ∏è Export HR Core Locations',
  style: {stretch: 'horizontal', margin: '4px 8px'},
  disabled: true
});

panel.add(exportCompositesButton);
panel.add(exportSubsamplesButton);
panel.add(exportHRCoresButton);

var downloadLinksPanel = ui.Panel({style: {margin: '0 8px'}});
panel.add(downloadLinksPanel);

var clearButton = ui.Button({
  label: 'Clear All & Start Over',
  style: {stretch: 'horizontal', margin: '8px'}
});
panel.add(clearButton);

// =================================================================================
// === 6. CORE SAMPLING FUNCTIONS ==================================================
// =================================================================================

/**
 * Main function to generate complete sampling design
 */
function generateSamplingDesign() {
  resultsPanel.clear();
  downloadLinksPanel.clear();
  map.layers().reset();
  
  var loading = ui.Label('Generating sampling design...', {
    color: '#666',
    fontStyle: 'italic',
    margin: '8px'
  });
  resultsPanel.add(loading);
  
  // Get AOI
  AppState.currentAoi = getAoi();
  if (!AppState.currentAoi) {
    resultsPanel.clear();
    resultsPanel.add(ui.Label('Please define an area of interest first!', STYLES.ERROR));
    return;
  }
  
  // Validate inputs
  var validations = validateInputs();
  if (!validations.valid) {
    resultsPanel.clear();
    resultsPanel.add(ui.Label(validations.message, STYLES.ERROR));
    return;
  }
  
  var params = validations.params;
  params.strategy = strategySelect.getValue();
  params.shape = shapeSelect.getValue();
  
  // Add AOI to map
  map.centerObject(AppState.currentAoi, 10);
  map.addLayer(AppState.currentAoi, {color: 'E53935'}, 'Area of Interest');
  map.addLayer(forestCarbon.clip(AppState.currentAoi), fcVis, 'Forest Carbon', false);
  map.addLayer(soilCarbon.clip(AppState.currentAoi), scVis, 'Soil Carbon', false);
  
  // Create sampling region (intersection of forest and soil data)
  var forestMask = forestCarbon.mask().selfMask().gt(0);
  var soilMask = soilCarbon.mask().selfMask().gt(0);
  var combinedMask = forestMask.and(soilMask);
  
  var samplingRegion = combinedMask.reduceToVectors({
    geometry: AppState.currentAoi,
    scale: CONFIG.CARBON_SCALE,
    geometryType: 'polygon',
    eightConnected: false,
    maxPixels: CONFIG.MAX_PIXELS,
    tileScale: 4
  }).union(CONFIG.MAX_ERROR);  // Union to simplify geometry
  
  // Generate HR cores
  generateHRCores(samplingRegion, params);
}

/**
 * Generate HR core locations
 */
function generateHRCores(samplingRegion, params) {
  try {
    var hrCorePoints = ee.FeatureCollection.randomPoints({
      region: samplingRegion,
      points: params.hrCores,
      seed: CONFIG.RANDOM_SEED
    });
    
    // Add IDs using mapping
    var hrCoresList = hrCorePoints.toList(params.hrCores);
    AppState.hrCores = ee.FeatureCollection(
      ee.List.sequence(0, ee.Number(params.hrCores).subtract(1)).map(function(i) {
        var pt = ee.Feature(hrCoresList.get(i));
        return pt.set({
          'core_id': ee.String('HR_').cat(ee.Number(i).format('%03d')),
          'type': 'hr_core',
          'lon': pt.geometry().coordinates().get(0),
          'lat': pt.geometry().coordinates().get(1)
        });
      })
    );
    
    // Continue with composites
    generateComposites(samplingRegion, params);
  } catch (error) {
    resultsPanel.clear();
    resultsPanel.add(ui.Label('Error generating HR cores: ' + error.message, STYLES.ERROR));
  }
}

/**
 * Generate composite polygons based on selected strategy
 */
function generateComposites(samplingRegion, params) {
  try {
    var compositePoints;
    
    if (params.strategy === 'Systematic Grid') {
      // Use stratified sampling for grid-like distribution
      compositePoints = Utils.createSystematicGrid(
        samplingRegion.geometry(),
        params.compositesPerStratum,
        CONFIG.RANDOM_SEED
      );
    } else if (params.strategy === 'Random') {
      compositePoints = ee.FeatureCollection.randomPoints({
        region: samplingRegion,
        points: params.compositesPerStratum,
        seed: CONFIG.RANDOM_SEED
      });
    } else {
      // Stratified Random - divide region and sample within strata
      var nStrata = 3;  // Could make this configurable
      var pointsPerStratum = Math.floor(params.compositesPerStratum / nStrata);
      
      // Simple stratification by carbon quantiles
      var carbonPercentiles = soilCarbon.reduceRegion({
        reducer: ee.Reducer.percentile([33, 67]),
        geometry: samplingRegion.geometry(),
        scale: CONFIG.CARBON_SCALE,
        maxPixels: CONFIG.MAX_PIXELS,
        tileScale: 4
      });
      
      // Generate points (simplified - would need proper stratification)
      compositePoints = ee.FeatureCollection.randomPoints({
        region: samplingRegion,
        points: params.compositesPerStratum,
        seed: CONFIG.RANDOM_SEED
      });
    }
    
    // Create composite polygons
    var pointsList = compositePoints.limit(params.compositesPerStratum).toList(params.compositesPerStratum);
    
    var compositeFeatures = ee.List.sequence(0, ee.Number(params.compositesPerStratum).subtract(1)).map(function(i) {
      var pt = ee.Feature(pointsList.get(i));
      
      var polygon;
      if (params.shape === 'Circle') {
        polygon = Utils.createCircle(pt, params.compositeArea);
      } else {
        // Use the simpler square method
        polygon = Utils.createSquareSimple(pt, params.compositeArea);
      }
      
      return polygon.set({
        'composite_id': ee.String('COMP_').cat(ee.Number(i).format('%03d')),
        'type': 'composite',
        'centroid_lon': pt.geometry().coordinates().get(0),
        'centroid_lat': pt.geometry().coordinates().get(1)
      });
    });
    
    AppState.composites = ee.FeatureCollection(compositeFeatures);
    
    // Generate subsamples
    generateSubsamples(params);
  } catch (error) {
    resultsPanel.clear();
    resultsPanel.add(ui.Label('Error generating composites: ' + error.message, STYLES.ERROR));
  }
}

/**
 * Generate subsample points within each composite
 */
function generateSubsamples(params) {
  try {
    var subsampleCollections = AppState.composites.map(function(comp) {
      var subPts = Utils.randomPointsInPolygon(comp, params.subsamples, CONFIG.RANDOM_SEED);
      
      var subPtsList = subPts.toList(params.subsamples);
      
      return ee.FeatureCollection(
        ee.List.sequence(0, ee.Number(params.subsamples).subtract(1)).map(function(i) {
          var pt = ee.Feature(subPtsList.get(i));
          return pt.set({
            'composite_id': comp.get('composite_id'),
            'subsample_id': ee.String(comp.get('composite_id')).cat('_S').cat(ee.Number(i).format('%02d')),
            'type': 'subsample',
            'lon': pt.geometry().coordinates().get(0),
            'lat': pt.geometry().coordinates().get(1)
          });
        })
      );
    }).flatten();
    
    AppState.subsamples = ee.FeatureCollection(subsampleCollections);
    
    // Perform pairing
    performPairing(params);
  } catch (error) {
    resultsPanel.clear();
    resultsPanel.add(ui.Label('Error generating subsamples: ' + error.message, STYLES.ERROR));
  }
}

/**
 * Pair composites with nearest HR cores
 */
function performPairing(params) {
  try {
    // Calculate nearest HR core for each composite using spatial join
    var compositesWithNearest = AppState.composites.map(function(comp) {
      var compCentroid = comp.geometry().centroid(CONFIG.MAX_ERROR);
      
      // Find nearest HR core
      var distances = AppState.hrCores.map(function(core) {
        var dist = compCentroid.distance(core.geometry(), CONFIG.MAX_ERROR);
        return core.set('distance_to_composite', dist);
      });
      
      var nearest = ee.Feature(distances.sort('distance_to_composite').first());
      
      return comp.set({
        'nearest_core_id': nearest.get('core_id'),
        'nearest_dist_m': nearest.get('distance_to_composite')
      });
    });
    
    // Select subset to pair based on distance and fraction
    var nToPair = ee.Number(params.compositesPerStratum).multiply(params.pairingFraction).floor();
    
    // Filter by max distance and select closest
    var eligibleForPairing = compositesWithNearest
      .filter(ee.Filter.lt('nearest_dist_m', CONFIG.DEFAULT_MAX_PAIRING_DISTANCE));
    
    var pairedComposites = eligibleForPairing
      .sort('nearest_dist_m')
      .limit(nToPair);
    
    var pairedIds = pairedComposites.aggregate_array('composite_id');
    
    // Update composites with pairing status
    AppState.composites = compositesWithNearest.map(function(comp) {
      var isPaired = ee.List(pairedIds).contains(comp.get('composite_id'));
      
      return ee.Feature(ee.Algorithms.If(
        isPaired,
        comp.set({
          'paired': 1,
          'paired_core_id': comp.get('nearest_core_id'),
          'paired_dist_m': comp.get('nearest_dist_m')
        }),
        comp.set({
          'paired': 0,
          'paired_core_id': null,
          'paired_dist_m': null
        })
      ));
    });
    
    AppState.composites = ee.FeatureCollection(AppState.composites);
    AppState.pairedComposites = AppState.composites.filter(ee.Filter.eq('paired', 1));
    
    // Display results
    displayResults(params);
  } catch (error) {
    resultsPanel.clear();
    resultsPanel.add(ui.Label('Error in pairing: ' + error.message, STYLES.ERROR));
  }
}

/**
 * Display results and statistics
 */
function displayResults(params) {
  resultsPanel.clear();
  
  // Calculate statistics
  ee.Dictionary({
    totalComposites: AppState.composites.size(),
    pairedComposites: AppState.pairedComposites.size(),
    totalSubsamples: AppState.subsamples.size(),
    totalHRCores: AppState.hrCores.size()
  }).evaluate(function(counts, error) {
    if (error) {
      resultsPanel.add(ui.Label('Error calculating statistics: ' + error, STYLES.ERROR));
      return;
    }
    
    // Display summary
    resultsPanel.add(ui.Label('Sampling Design Summary', STYLES.HEADER));
    
    resultsPanel.add(ui.Label(
      '‚úì HR Cores: ' + counts.totalHRCores,
      {fontSize: '13px', margin: '4px 8px', color: '#388E3C'}
    ));
    
    resultsPanel.add(ui.Label(
      '‚úì Composites: ' + counts.totalComposites + 
      ' (' + counts.pairedComposites + ' paired)',
      {fontSize: '13px', margin: '4px 8px', color: '#388E3C'}
    ));
    
    resultsPanel.add(ui.Label(
      '‚úì Subsamples: ' + counts.totalSubsamples + 
      ' (' + params.subsamples + ' per composite)',
      {fontSize: '13px', margin: '4px 8px', color: '#388E3C'}
    ));
    
    // Calculate pairing statistics if any paired
    if (counts.pairedComposites > 0) {
      AppState.pairedComposites.aggregate_stats('paired_dist_m').evaluate(function(stats) {
        resultsPanel.add(ui.Label(''));
        resultsPanel.add(ui.Label('Pairing Distance Statistics:', STYLES.SUBHEADER));
        resultsPanel.add(ui.Label(
          'Mean: ' + Utils.formatNumber(stats.mean, 1) + ' m',
          {fontSize: '12px', margin: '4px 8px'}
        ));
        resultsPanel.add(ui.Label(
          'Range: ' + Utils.formatNumber(stats.min, 1) + ' - ' + 
          Utils.formatNumber(stats.max, 1) + ' m',
          {fontSize: '12px', margin: '4px 8px'}
        ));
      });
    }
    
    // Calculate carbon statistics
    resultsPanel.add(ui.Label(''));
    resultsPanel.add(ui.Label('Calculating carbon statistics...', {
      fontSize: '12px',
      fontStyle: 'italic',
      margin: '4px 8px'
    }));
    
    Utils.calculateCarbonStats(AppState.currentAoi).evaluate(function(carbonStats) {
      resultsPanel.add(ui.Label('Carbon Statistics:', STYLES.SUBHEADER));
      resultsPanel.add(ui.Label(
        'Mean soil carbon: ' + carbonStats.b1_mean.toFixed(2) + ' t/ha',
        {fontSize: '12px', margin: '4px 8px'}
      ));
      resultsPanel.add(ui.Label(
        'Std deviation: ' + carbonStats.b1_stdDev.toFixed(2) + ' t/ha',
        {fontSize: '12px', margin: '4px 8px'}
      ));
      resultsPanel.add(ui.Label(
        'CV: ' + (carbonStats.b1_stdDev / carbonStats.b1_mean * 100).toFixed(1) + '%',
        {fontSize: '12px', margin: '4px 8px'}
      ));
    });
    
    // Add layers to map with proper styling
    var compositeStyle = {color: '0000FF', fillColor: '0000FF40'};
    var pairedStyle = {color: '00FF00', fillColor: '00FF0040'};
    var hrStyle = {color: 'FF0000', pointSize: 5};
    var subsampleStyle = {color: 'FFFF00', pointSize: 2};
    
    map.addLayer(AppState.composites.filter(ee.Filter.eq('paired', 0)), 
                 compositeStyle, 'Unpaired Composites');
    map.addLayer(AppState.pairedComposites, pairedStyle, 'Paired Composites');
    map.addLayer(AppState.hrCores, hrStyle, 'HR Core Locations');
    map.addLayer(AppState.subsamples, subsampleStyle, 'Subsample Points', false);
    
    // Enable export buttons
    exportCompositesButton.setDisabled(false);
    exportSubsamplesButton.setDisabled(false);
    exportHRCoresButton.setDisabled(false);
    
    resultsPanel.add(ui.Label('‚úì Sampling design generated successfully', STYLES.SUCCESS));
    
    // Print to console
    print('‚úì Sampling design completed');
    print('Strategy:', params.strategy);
    print('Shape:', params.shape);
    print('Composites:', counts.totalComposites);
    print('Paired:', counts.pairedComposites);
    print('Subsamples:', counts.totalSubsamples);
    print('HR Cores:', counts.totalHRCores);
  });
}

// =================================================================================
// === 7. HELPER FUNCTIONS =========================================================
// =================================================================================

/**
 * Gets AOI from drawing tools or asset
 */
function getAoi() {
  var method = aoiSelection.getValue();
  
  if (method === 'Draw a polygon') {
    var layers = map.drawingTools().layers();
    if (layers.length() === 0) {
      return null;
    }
    var geometries = layers.get(0).geometries();
    if (geometries.length() === 0) {
      return null;
    }
    return layers.get(0).toGeometry();
  } else {
    var assetId = assetIdBox.getValue();
    if (!assetId || assetId.trim() === '') {
      return null;
    }
    try {
      var fc = ee.FeatureCollection(assetId);
      return fc.geometry();
    } catch (e) {
      alert('Failed to load asset: ' + e.message);
      return null;
    }
  }
}

/**
 * Validates all input parameters
 */
function validateInputs() {
  var hrCoresVal = Utils.validateNumber(hrCoresBox.getValue(), 1, 100, 'HR Cores');
  if (!hrCoresVal.valid) return hrCoresVal;
  
  var compositesVal = Utils.validateNumber(compositesBox.getValue(), 1, 500, 'Composites per stratum');
  if (!compositesVal.valid) return compositesVal;
  
  var areaVal = Utils.validateNumber(compositeAreaBox.getValue(), 1, 10000, 'Composite area');
  if (!areaVal.valid) return areaVal;
  
  var subsamplesVal = Utils.validateNumber(subsamplesBox.getValue(), 1, 50, 'Subsamples');
  if (!subsamplesVal.valid) return subsamplesVal;
  
  var pairingVal = Utils.validateNumber(pairingFractionBox.getValue(), 0, 1, 'Pairing fraction');
  if (!pairingVal.valid) return pairingVal;
  
  return {
    valid: true,
    params: {
      hrCores: hrCoresVal.value,
      compositesPerStratum: compositesVal.value,
      compositeArea: areaVal.value,
      subsamples: subsamplesVal.value,
      pairingFraction: pairingVal.value
    }
  };
}

/**
 * Export functions with download links
 */
exportCompositesButton.onClick(function() {
  if (!AppState.composites) {
    alert('Please generate sampling design first.');
    return;
  }
  
  downloadLinksPanel.clear();
  
  var format = exportFormatSelect.getValue();
  
  // Prepare data with all attributes
  var exportData = AppState.composites.map(function(f) {
    return f.set({
      'export_format': format,
      'export_date': ee.Date(Date.now()).format('YYYY-MM-dd')
    });
  });
  
  var downloadUrl = exportData.getDownloadURL({
    format: format === 'SHP' ? 'SHP' : format,
    filename: 'composite_polygons_' + new Date().getTime()
  });
  
  var link = ui.Label({
    value: '‚¨áÔ∏è Download Composite Polygons (' + format + ')',
    style: {
      color: '#1976D2',
      textDecoration: 'underline',
      margin: '8px',
      fontSize: '13px',
      fontWeight: 'bold'
    },
    targetUrl: downloadUrl
  });
  
  downloadLinksPanel.add(link);
  print('‚úì Composite polygons export link generated');
});

exportSubsamplesButton.onClick(function() {
  if (!AppState.subsamples) {
    alert('Please generate sampling design first.');
    return;
  }
  
  downloadLinksPanel.clear();
  
  var format = exportFormatSelect.getValue();
  
  var exportData = AppState.subsamples.map(function(f) {
    return f.set({
      'export_format': format,
      'export_date': ee.Date(Date.now()).format('YYYY-MM-dd')
    });
  });
  
  var downloadUrl = exportData.getDownloadURL({
    format: format === 'SHP' ? 'SHP' : format,
    filename: 'subsample_points_' + new Date().getTime()
  });
  
  var link = ui.Label({
    value: '‚¨áÔ∏è Download Subsample Points (' + format + ')',
    style: {
      color: '#1976D2',
      textDecoration: 'underline',
      margin: '8px',
      fontSize: '13px',
      fontWeight: 'bold'
    },
    targetUrl: downloadUrl
  });
  
  downloadLinksPanel.add(link);
  print('‚úì Subsample points export link generated');
});

exportHRCoresButton.onClick(function() {
  if (!AppState.hrCores) {
    alert('Please generate sampling design first.');
    return;
  }
  
  downloadLinksPanel.clear();
  
  var format = exportFormatSelect.getValue();
  
  var exportData = AppState.hrCores.map(function(f) {
    return f.set({
      'export_format': format,
      'export_date': ee.Date(Date.now()).format('YYYY-MM-dd')
    });
  });
  
  var downloadUrl = exportData.getDownloadURL({
    format: format === 'SHP' ? 'SHP' : format,
    filename: 'hr_core_locations_' + new Date().getTime()
  });
  
  var link = ui.Label({
    value: '‚¨áÔ∏è Download HR Core Locations (' + format + ')',
    style: {
      color: '#1976D2',
      textDecoration: 'underline',
      margin: '8px',
      fontSize: '13px',
      fontWeight: 'bold'
    },
    targetUrl: downloadUrl
  });
  
  downloadLinksPanel.add(link);
  print('‚úì HR core locations export link generated');
});

clearButton.onClick(function() {
  var confirmed = confirm('This will clear all generated sampling locations. Continue?');
  if (!confirmed) return;
  
  AppState.reset();
  map.layers().reset();
  map.drawingTools().clear();
  map.drawingTools().setShown(true);
  resultsPanel.clear();
  downloadLinksPanel.clear();
  
  exportCompositesButton.setDisabled(true);
  exportSubsamplesButton.setDisabled(true);
  exportHRCoresButton.setDisabled(true);
  
  // Reset form values to defaults
  hrCoresBox.setValue(CONFIG.DEFAULT_HR_CORES.toString());
  compositesBox.setValue(CONFIG.DEFAULT_COMPOSITES_PER_STRATUM.toString());
  compositeAreaBox.setValue(CONFIG.DEFAULT_COMPOSITE_AREA.toString());
  subsamplesBox.setValue(CONFIG.DEFAULT_SUBSAMPLES.toString());
  pairingFractionBox.setValue(CONFIG.DEFAULT_PAIRING_FRACTION.toString());
  strategySelect.setValue('Systematic Grid');
  shapeSelect.setValue('Square');
  
  print('‚úì Tool reset successfully');
});

// =================================================================================
// === 8. INITIALIZE THE APP =======================================================
// =================================================================================

var drawingTools = map.drawingTools();
drawingTools.setShown(true);
drawingTools.setLinked(false);
drawingTools.setDrawModes(['polygon', 'rectangle']);
drawingTools.setShape('polygon');

// Add basic map controls
map.setControlVisibility({
  all: false,
  layerList: true,
  zoomControl: true,
  scaleControl: true,
  mapTypeControl: true,
  fullscreenControl: false,
  drawingToolsControl: true
});

// Print welcome message
print('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
print('üå≤ Nature Meets Carbon - Composite Sampling Tool (Fixed)');
print('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
print('');
print('This version fixes geometry projection issues while maintaining');
print('all core functionality.');
print('');
print('Features:');
print('  ‚Ä¢ Three sampling strategies: Systematic, Random, Stratified');
print('  ‚Ä¢ Two composite shapes: Square and Circle');
print('  ‚Ä¢ HR core and composite pairing optimization');
print('  ‚Ä¢ Multiple export formats');
print('  ‚Ä¢ Carbon statistics calculation');
print('');
print('Instructions:');
print('  1. Draw or select your area of interest');
print('  2. Configure sampling parameters');
print('  3. Click "Generate Sampling Locations"');
print('  4. Export results in your preferred format');
print('');
print('Ready to use!');
